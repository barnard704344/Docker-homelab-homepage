# Homelab Homepage (Scanner + Web in one container)

A lightweight **start page** for your homelab, served by **Nginx** inside Docker.  
It shows your **static links** (in `site/index.html`) and auto-populates a **Discovered** group from a background **nmap + DNS** scanner that writes `services.json`.

- Press `/` to search  
- ⭐ Pin favourites (saved per device, in the browser)  
- Live status dots (quick reachability checks)  
- Single container: **web server + scanner** together  

---

## Folder layout

```text
homelab-homepage/
├─ Dockerfile
├─ run.sh
├─ scan.sh
├─ ports.map
├─ nginx.conf
└─ site/
   └─ index.html
```

`site/index.html` is already wired to pull `services.json` generated by the scanner.

---

## Quick start (build + run)

```bash
# From the repo root
docker build -t homelab-homepage:latest .

# Run (adapt envs to your LAN)
docker run -d \
  --name homelab-homepage \
  -p 8080:8080 \
  --cap-add=NET_RAW --cap-add=NET_ADMIN \
  -e SUBNETS="10.72.28.0/22 10.136.40.0/24" \
  -e PORTS="80,443,8006,8080,8443,32400,9090,9093,9000,3000,3001,32168,8123,5601,9200" \
  -e DNS_SERVER="10.72.28.2" \
  -e SEARCH_DOMAINS="local shs.lan" \
  -e HOSTNAMES="proxmox.local grafana.local portainer.local obico.local" \
  -e INTERVAL="600" \
  -e USE_TLS_MAP="true" \
  homelab-homepage:latest
```

Open: `http://<docker-host>:8080/`

On Linux you can optionally use `--network host` for faster/cleaner scans. Example:

```bash
docker run -d --name homelab-homepage --network host \
  --cap-add=NET_RAW --cap-add=NET_ADMIN \
  -e SUBNETS="10.72.28.0/22 10.136.40.0/24" \
  -e DNS_SERVER="10.72.28.2" \
  homelab-homepage:latest
```

Then browse to `http://localhost:8080/`.

## Docker Compose (alternative to docker run)

Create `docker-compose.yml` in the repo root:

```yaml
version: "3.9"
services:
  homelab-homepage:
    build: .
    container_name: homelab-homepage
    ports:
      - "8080:8080"
    cap_add:
      - NET_RAW
      - NET_ADMIN
    environment:
      SUBNETS: "10.72.28.0/22 10.136.40.0/24"
      PORTS: "80,443,8006,8080,8443,32400,9090,9093,9000,3000,3001,32168,8123,5601,9200"
      DNS_SERVER: "10.72.28.2"
      SEARCH_DOMAINS: "local shs.lan"
      HOSTNAMES: "proxmox.local grafana.local portainer.local obico.local"
      INTERVAL: "600"
      USE_TLS_MAP: "true"
    restart: unless-stopped
    # For Linux hosts you may prefer host networking (comment 'ports' above if you use this)
    # network_mode: host
```

Run:

```bash
docker compose up -d
```

## How it works

`scan.sh` runs in a loop (INTERVAL seconds) and:

1. Scans SUBNETS using `nmap -n -Pn --open -p PORTS ...`
2. Performs PTR (`dig -x`) and A lookups against DNS_SERVER (if set)
3. Optionally brute-forces common hostnames against SEARCH_DOMAINS
4. Adds explicit HOSTNAMES as seeds
5. Writes a strict JSON array to `/var/www/site/services.json`

`site/index.html` loads `services.json`, merges with your static LINKS, dedupes by URL/title, renders responsive cards, and does fast HEAD checks for the coloured status dot.

`ports.map` defines per-port defaults (scheme/tag/description). Extend it anytime.

## Environment variables

| Variable | Default | Purpose |
|----------|---------|---------|
| `SUBNETS` | (empty) | Space-separated CIDRs to scan, e.g. `10.72.28.0/22 10.136.40.0/24` |
| `PORTS` | `80,443,8006,8080,8443,32400,9090,9093,9000,3000,3001,32168,8123,5601,9200` | Comma-separated ports to probe |
| `DNS_SERVER` | (empty) | Internal resolver for PTR/A lookups (e.g. `10.72.28.2`) |
| `SEARCH_DOMAINS` | (empty) | Domains to brute-force common hostnames (e.g. `local shs.lan`) |
| `HOSTNAMES` | (empty) | Space-separated hostnames to seed (e.g. `proxmox.local grafana.local`) |
| `INTERVAL` | `600` | Rescan interval in seconds |
| `USE_TLS_MAP` | `true` | Guess HTTPS for common ports (443/8443/8006/32400/3000/3001/8123/5601) |

## Customization

### Static links

Edit `site/index.html` and modify the LINKS array:

```js
const LINKS = [
  { title: "Proxmox", url: "https://proxmox.local:8006", group: "Core", desc: "Hypervisor cluster", tags:["vm","cluster"], statusPath:"/" },
  { title: "Portainer", url: "https://portainer.local", group: "Core", desc: "Docker UI", tags:["docker"], statusPath:"/" },
  // ...
];
```

- **group**: column grouping (create/rename as you like)
- **tags**: controls badge + icon (e.g., `vm`, `docker`, `metrics`, `media`, `ai`)
- **statusPath**: optional (defaults to `/`), set to a lightweight health endpoint if you have one

### Port mapping logic

Add or override rows in `ports.map`:

```text
# port,scheme,tag,desc
80,http,web,HTTP
443,https,web,HTTPS
8006,https,vm,Proxmox
...
```

The scanner uses this to:
- Choose `http` vs `https` (unless overridden by `USE_TLS_MAP`)
- Tag cards (e.g., `metrics`, `docker`, `media`)
- Provide a human-readable description in the Discovered list

### services.json schema

The scanner writes an array of objects:

```json
[
  {
    "title": "proxmox.local",
    "url": "https://proxmox.local:8006",
    "group": "Discovered",
    "desc": "Proxmox",
    "tags": ["vm"],
    "statusPath": "/"
  }
]
```

The UI merges this with your LINKS and dedupes by URL (fallback: title).

## Security notes

- The container needs `--cap-add=NET_RAW --cap-add=NET_ADMIN` for nmap.
- Limit SUBNETS precisely to your lab ranges.
- The UI does no credential storage; it just links to your services.
- Status dots use quick HEAD fetches; CORS-protected services may show as "uncertain" or "offline" even if they're up—set `statusPath` to a permissive endpoint where possible.

## Troubleshooting

### No Discovered items
- Verify SUBNETS and PORTS
- Check logs: `docker logs homelab-homepage`
- Ensure firewall allows the container to probe hosts/ports

### Wrong scheme (http/https)
- Set `USE_TLS_MAP=false` to stop auto-guessing
- Edit `ports.map` to force schemes

### CORS causing red dots
- Scanner still discovers items; status dots are a separate fetch
- Use a health endpoint that allows cross-origin HEAD, or ignore the dot colour

## Development

Rebuild after changes:

```bash
docker build -t homelab-homepage:latest .
docker stop homelab-homepage && docker rm homelab-homepage
# rerun with your preferred docker run / compose command
```

## License

MIT — use freely in your homelab.
